<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4. Refactor - 25 minutes :: Modern Application Development Roadshow - Dev Track</title>
    <link rel="canonical" href="http://localhost:3000/mad-dev-guides-m2/main/2-refactor.html">
    <link rel="prev" href="1-introduction.html">
    <link rel="next" href="3-deploy-to-kubernetes.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () { 
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('USERID');
      const subDomain = urlParams.get('SUBDOMAIN');
      const tomcatIP = urlParams.get('TOMCATIP');
      if (userId) {
        showUserId( userId );
      }
      else {
        showUserIdForm();
      }
    } );


    function showUserId( userId ) {
      document.getElementById('navbar-form-empty').style.display = "none";
      document.getElementById('navbar-form-filled').style.display = "flex";
      document.getElementById('username').textContent = userId;
      document.getElementById('subDomain').value = subDomain;
      document.getElementById('tomcatIP').value = tomcatIP;

    }

    function showUserIdForm( userId ) {
      document.getElementById('navbar-form-empty').style.display = "flex";
      document.getElementById('navbar-form-filled').style.display = "none";
    }

    function goWithUserId() {
      elUserIdInput = document.getElementById('userId');
      elSubDomainInput = document.getElementById('subDomain');
      elTomcatIPInput = document.getElementById('tomcatIP');

      window.location.search = ('&USERID=' + elUserIdInput.value + '&SUBDOMAIN=' + elSubDomainInput.value + '&TOMCATIP=' + elTomcatIPInput.value);
    }

  </script>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/products/runtimes" target="_blank"><img
          src="../../_/img/Logo-Red_Hat-Runtimes-A-Reverse-RGB.png" height="40px" alt="Red Hat Runtimes"></a>
      <a class="navbar-item" href="http://localhost:3000" style="color: white;"><h3>Modern Application Development Roadshow - Dev Track</h3></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item" id="navbar-form-empty">
          <span class="navbar-text" style="margin-left: 1rem;">Your Workshop Environment</span>
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i style="color: orange;"
              class="fa fa-exclamation-triangle" aria-hidden="true"></i></span>

          <form action="javascript:void(0);" onsubmit="goWithUserId();">
            <div class="navbar-item" id="navbar-form-project-filled" style="display: none;">
              <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">|</span>
            </div>
            <input size="40" id="userId" type="text" placeholder="Enter USER ID">
            <input type="hidden" id="subDomain" name="subDomain" value="">
            <input type="hidden" id="tomcatIP" name="tomcatIP" value="">
          </form>
        </div>
        
        <div class="navbar-item" id="navbar-form-filled" style="display: none;">
          <span class="navbar-text" style="margin-left: 1rem;">Your Workshop Environment</span>
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">|</span>
          <span class="navbar-text" id="username"></span>
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i></span>
        </div>

    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="mad-dev-guides-m2" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="1-introduction.html" class=" query-params-link">Module 2</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1-introduction.html">Introduction</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="2-refactor.html">Refactor</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="3-deploy-to-kubernetes.html">Deploy to Kubernetes</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Module 2</span>
    <span class="version">main</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Module 2</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="1-introduction.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="1-introduction.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="1-introduction.html">Module 2</a></li>
    <li><a href="2-refactor.html">Refactor</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/danieloh/Downloads/dev-guides/mad-dev-guides-m2/documentation/modules/ROOT/pages/2-refactor.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">4. Refactor - 25 minutes</h1>
<div class="sect1">
<h2 id="_goals_of_this_lab"><a class="anchor" href="#_goals_of_this_lab"></a>Goals of this lab</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal is to understand the modernization issues of the <code>customers</code> application and learn how you can fix them by the code modification. The MTA report also provides the details in terms of the <strong>file name</strong>, <strong>path</strong>, and <strong>solution recommendations</strong> for each issue.</p>
</div>
<div class="paragraph">
<p>In this lab you will also analyze the customers application once again using MTA if the all issue are fixed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_1_explore_the_migration_issues"><a class="anchor" href="#_4_1_explore_the_migration_issues"></a>4.1. Explore the Migration issues</h2>
<div class="sectionbody">
<div class="paragraph">
<p>According to the analysis report, the migration issues are related to external configurations with hard coded static IP addresses. Let&#8217;s dig into the issue on the code level.</p>
</div>
<div class="paragraph">
<p>Go to the web browser that opens the VS Code server. Explore the <code>customers-tomcat-legacy</code> project to open <code>PersistenceConfig.java</code> file in <strong>src/main/java/io/konveyor/demo/ordermanagement/config</strong> directory.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/persistence-class.png" alt="persistence-class">
</div>
</div>
<div class="paragraph">
<p>The <strong>dataSource()</strong> method creates an <code>ApplicationConfiguration</code> instance to configure the JDBC variables such as <em>driverClassName</em>, <em>url</em>, <em>user</em>, and <em>password</em>. The ApplicationConfiguration ends up with referring to the hard coded IP address in <code>persistence.properties</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/applicationConfiguration-class.png" alt="applicationConfiguration-class">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_2_understand_the_solution"><a class="anchor" href="#_4_2_understand_the_solution"></a>4.2. Understand the Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>customers-tomcat-ocp</code> project implements the <strong>Customers</strong> application with all the required changes and deploy the applications to OpenShift (Kubernetes). It also defines an OpenShift manifests file in the <code>ocp</code> directory.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-manifests.png" alt="ocp-manifests">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s find out how to fix the above configuration issue. Move to <code>customers-tomcat-ocp</code> project. Then, open <code>PersistenceConfig.java</code> file in <strong>src/main/java/io/konveyor/demo/ordermanagement/config</strong> directory and <code>pom.xml</code> file.</p>
</div>
<div class="paragraph">
<p><strong>ApplicationConfiguration</strong> class isn&#8217;t required anymore to configure the JDBC variables but the <strong>datasource</strong> method still needs to use the environment instance. When you take a look at the <strong>pom.xml</strong>, the static properties file will be excluded when the application is building.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/appconfig-pom-ocp.png" alt="appconfig-pom-ocp">
</div>
</div>
<div class="paragraph">
<p>Using the kubernetes profile in the build is essential for the application to pick up the configuration file injected via a secret in the pod. That secret also has to be  created manually which would normally be done by packaging with maven. To generate these <em>Kubernetes</em> resources, you usually run the following maven command with the <em>Kubernetes</em> profile.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You don&#8217;t need to run the following maven command today since you already have the solution artifact (<code>customers-tomcat-solution.war</code>) that are packaged with the fixed code by using the Kubernetes profile.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">mvn clean package -P kubernetes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to the MTA web console. Then, create a new project to analyze the solution artifact.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Project name: <code>New Customers Service</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Select the <code>customers-tomcat-solution.war</code> file from your local file system in the <strong>Add applications</strong> page.</p>
</div>
<div class="paragraph">
<p>Configure the project with the same settings and custom rules that we used for the Customers Service project. Once the report is finished, verify that it now reports <code>0</code> Story Points.</p>
</div>
<div class="paragraph">
<p>You have successfully migrated this app and now ready to deploy to OpenShift, <strong>congratulations!</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/report-solution-view.png" alt="View report">
</div>
</div>
<div class="paragraph">
<p>➡️ <a href="./5-rehost.adoc">5. Rehost</a></p>
</div>
<div class="paragraph">
<p>⬅️ <a href="./3-analyze.adoc">3. Analyze</a></p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="1-introduction.html" class="query-params-link">Introduction</a></span>
  <span class="next"><a href="3-deploy-to-kubernetes.html" class="query-params-link">Deploy to Kubernetes</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
